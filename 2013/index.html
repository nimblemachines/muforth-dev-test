<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="copyright" content="All content on muforth.dev is copyrighted. All rights are reserved." />
<meta name="keywords" content="journal, blog, 2013" />
<meta name="robots" content="noindex,nofollow" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="/-/screen.css" type="text/css" />
<link rel="icon" href="/-/9s08_hc595_150x150.jpg" type="image/jpeg" />
<link rel="canonical" href="https://www.muforth.dev/2013/" />
<title>2013 journal &ndash; muforth</title>
</head>
<body>

<div id="header">
<h1>2013 journal</h1>
<hr />
</div>

<div id="content">
<h3 id="august-08-16:55"><a href="#august-08-16:55">2013 August 08 16:55</a></h3>
<p>After piecemeal work on it over the last few months, I&rsquo;ve been intensively working for the past week or so on Cortex-M support in <a href="/">muforth</a>.</p>
<p>In order to try to understand the <a href="https://www.nimblemachines.com/cmsis-dap/">CMSIS-DAP</a> code &ndash; in particular, how one writes an OpenSDA application &ndash; I ended up adding almost all the &ldquo;everyday&rdquo; ARMv7-M instructions to the disassembler &ndash; ALU ops, memory loads and stores, but none of the floating point or exotic SIMD instructions.</p>
<p>I finally finished the Cortex-M0 (ie, ARMv6-M) assembler, and just two days ago added basic debug support for the <a href="https://www.nimblemachines.com/cheap-cortex-m-boards/#stellaris-launchpad">Stellaris Launchpad</a>, a bright red ten-dollar board with an 80MHz ARM Cortex-M4F processor on it.</p>
<p>I&rsquo;m working on a native Forth compiler that initially will target the Cortex-M0, but that means it will run fine (just slower than ideal) on Cortex-M3 and -M4 parts. (I can always tweak and improve it later to support the M3 and M4.)</p>
<p>The CMSIS-DAP support &ndash; for the <a href="https://www.nimblemachines.com/cheap-cortex-m-boards/#freescale-frdm-freedom-boards">Freescale Freedom board</a> &ndash; is working fine, but seems a bit <em>slow</em>. I think doing debug over HID packets is a mistake; using bulk endpoints, or even doing control transfers (like I do for the S08JS16) seems much faster. Since I have access to the CMSIS-DAP source code, I know that they have up to 32 packets in a ring. In an effort to get things to go faster, I changed my code to have up to 16 packets &ldquo;in the air&rdquo; at a time; sadly, a large transfer (reading 128KiB of flash) went only two times faster.</p>
<p>Fundamentally I don&rsquo;t care about the performance of CMSIS-DAP &ndash; or any of these built-in debug protocols. I plan to use them only to explore the board and chip, and to get <em>my</em> debug stub code onto the chip. Once I&rsquo;ve done that I can ignore their firmware entirely. Of course this means mastering the curiousities of (currently) three ways to program the flash and talk to the USB. One reason I&rsquo;m working on getting my Forth meta-compiler working is that I&rsquo;d ideally like to write my USB debug stub in Forth. The stub &ndash; and all other little USB &ldquo;apps&rdquo; &ndash; I&rsquo;ve written for the S08JS16 is assembler (all 512 bytes of it. ;-)</p>
<p>All in all, I&rsquo;m pretty happy with my progress. Once the Forth (meta)compiler is done, I can start thinking about adding ARMv7-M instructions to the assembler.</p>
<hr />
<h3 id="february-06-11:46"><a href="#february-06-11:46">2013 February 06 11:46</a></h3>
<p>After a few recent breakthroughs, I&rsquo;m now able to connect to the <a href="https://www.nimblemachines.com/cmsis-dap/">CMSIS-DAP</a> firmware on my <a href="https://www.nimblemachines.com/cheap-cortex-m-boards/#freescale-frdm-freedom-boards">Freescale Freedom board</a> and successfully read and write core registers and memory &ndash; using <a href="/">muforth</a>!</p>
<p>Two days ago, after modifying the OSX USB support in muforth (to support USB HIDs), I was able to turn the &ldquo;connect&rdquo; LED on the board on and off. This meant that the connection between muforth and the HID firmware was working.</p>
<p>Then, yesterday afternoon I successfully read the IDCODE from the on-chip SW-DP. This required getting the connection sequence right &ndash; sending a binary string to the SW-DP. ARM&rsquo;s documentation &ndash; the <a href="http://infocenter.arm.com/help/topic/com.arm.doc.ihi0031a/">ARM Debug Interface v5 spec</a> and the <a href="http://infocenter.arm.com/help/topic/com.arm.doc.prdc008772b/">ADI v5.1 supplement</a> &ndash; disagreed on what this sequence should be. I settled on sending 56 ones followed by 8 zeros, and this seemed to work.</p>
<p>My next hurdle was to try to read the chip&rsquo;s memory. But any access to AP (access port) registers failed, returning a FAULT. It turns out that it is necessary to first turn on the CSYSPWRUPREQ and CSYSDBGREQ bits in the DP.CTRLSTAT register... Once I did this, the chip was mine!</p>
<p>Very cool.</p>
<hr />
<p>Read the <a href="/2010/">2010 journal</a>.</p>

</div>

<div id="footer">
<hr />
<a href="mailto:%77%65%62%68%61%6d%73%74%65%72%40%6e%69%6d%62%6c%65%6d%61%63%68%69%6e%65%73%2e%63%6f%6d?subject=%5bmuforth%5d%202013%20journal">Send feedback</a> on this page (last edited 2016 November 12 14:13)<br />
Browse <a href="/all-pages/">all pages</a>, or return <a href="/">home</a><br />
<a href="https://twitter.com/share?url=https%3a%2f%2fwww.muforth.dev%2f2013%2f&text=Say%20something%20nice!">Tweet</a> this page, or follow <a href="https://twitter.com/muforth">@muforth</a>
</div>

</body>
</html>
